*&---------------------------------------------------------------------*
*& Report ZTENDER_VENDOR_SELECT
*&---------------------------------------------------------------------*

REPORT ZTENDER_VENDOR_SELECT.

*---------------------------------------------------------------------*
* Program Name : ZTENDER_VENDOR_SELECT
* Description  : Vendor Selection & Validation for Tender
*---------------------------------------------------------------------*



*---------------------------------------------------------------------*
* Selection Screen
*---------------------------------------------------------------------*
PARAMETERS: p_tender TYPE ztender_hdr-tender_id OBLIGATORY,
            p_ekorg  TYPE ekorg OBLIGATORY.

*---------------------------------------------------------------------*
* Data Declarations
*---------------------------------------------------------------------*
DATA: lt_lfm1 TYPE TABLE OF lfm1,
      ls_lfm1 TYPE lfm1.

DATA: ls_lfa1 TYPE lfa1.
DATA: ls_vendor TYPE ztender_vendor.
DATA: lv_count TYPE i.

*---------------------------------------------------------------------*
* Start of Selection
*---------------------------------------------------------------------*
START-OF-SELECTION.

*---------------------------------------------------------------------*
* Step 1: Validate Tender
*---------------------------------------------------------------------*
SELECT SINGLE tender_id
  FROM ztender_hdr
  INTO @DATA(lv_tender)
 WHERE tender_id = @p_tender.

IF sy-subrc <> 0.
  MESSAGE 'Tender ID does not exist' TYPE 'E'.
ENDIF.

*---------------------------------------------------------------------*
* Step 2: Fetch Vendors from LFM1
*---------------------------------------------------------------------*
SELECT *
  FROM lfm1
  INTO TABLE lt_lfm1
 WHERE ekorg = p_ekorg
   AND loevm = space.      "Not deleted

IF sy-subrc <> 0.
  MESSAGE 'No vendors found for Purchasing Org' TYPE 'E'.
ENDIF.
*---------------------------------------------------------------------*
* Step 3: Vendor Validation & Insert (UPDATED)
*---------------------------------------------------------------------*
CLEAR lv_count.

LOOP AT lt_lfm1 INTO ls_lfm1.

  "Fetch Vendor Master (Not Blocked)
  SELECT SINGLE *
    FROM lfa1
    INTO ls_lfa1
   WHERE lifnr = ls_lfm1-lifnr
     AND sperr = space.

  IF sy-subrc = 0.

    CLEAR ls_vendor.

    "Key Fields
    ls_vendor-tender_id  = p_tender.
    ls_vendor-lifnr      = ls_lfm1-lifnr.

    "Bid & Vendor Status
    ls_vendor-bid_status = 'INVITED'.
    ls_vendor-VENDOR_STAUTS   = 'ACTIVE'.

    "Commercial Defaults
    ls_vendor-tech_score = 0.
    ls_vendor-currency   = 'INR'.
    ls_vendor-price      = 0.

    "PAN Number
    ls_vendor-pan_no = ls_lfa1-stcd1.

    "Region
    ls_vendor-region = ls_lfa1-regio.

    "Certificate Validity (1 year)
    ls_vendor-cert_valid_to = sy-datum + 365.

    "Insert Vendor Mapping
    INSERT ztender_vendor FROM ls_vendor.

    IF sy-subrc = 0.
      lv_count = lv_count + 1.
    ENDIF.

  ENDIF.

ENDLOOP.


*---------------------------------------------------------------------*
* Step 4: Commit & Message
*---------------------------------------------------------------------*
COMMIT WORK.

MESSAGE |{ lv_count } vendors mapped to Tender { p_tender }| TYPE 'S'.